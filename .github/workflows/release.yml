name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  DOTNET_VERSION: '8.0.x'
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        python -m pip install pyinstaller

    - name: Download YOLOv8 model
      shell: pwsh
      run: |
        # Download the YOLOv8n ONNX model if it doesn't exist
        if (-not (Test-Path "yolov8n.onnx")) {
          Write-Host "Downloading YOLOv8n ONNX model..."
          python -c "from ultralytics import YOLO; model = YOLO('yolov8n.pt'); model.export(format='onnx')"
          
          # Verify the file was created
          if (-not (Test-Path "yolov8n.onnx")) {
            Write-Error "Failed to download/export YOLOv8n ONNX model"
            exit 1
          }
          Write-Host "YOLOv8n ONNX model downloaded successfully"
        } else {
          Write-Host "YOLOv8n ONNX model already exists"
        }

    - name: Get version from tag or input
      id: get_version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "${{ github.ref }}" -replace 'refs/tags/v', ''
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "VERSION_MSIX=$version.0" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Build application
      shell: pwsh
      run: |
        .\build.ps1 -Version "${{ steps.get_version.outputs.VERSION }}" -Configuration Release -Runtime win-x64

    - name: Verify build output
      shell: pwsh
      run: |
        if (-not (Test-Path "publish/HoldSense/HoldSense.exe")) {
          Write-Error "Build failed: HoldSense.exe not found"
          exit 1
        }
        if (-not (Test-Path "publish/HoldSense/backend/HoldSenseBackend.exe")) {
          Write-Error "Build failed: Backend executable not found"
          exit 1
        }
        Write-Host "Build verification passed!"

    - name: Create portable ZIP
      shell: pwsh
      run: |
        Compress-Archive -Path "publish/HoldSense/*" -DestinationPath "HoldSense-Portable-v${{ steps.get_version.outputs.VERSION }}.zip"

    - name: Setup Inno Setup
      run: |
        choco install innosetup -y

    - name: Build EXE installer
      shell: pwsh
      run: |
        $env:PATH = "C:\Program Files (x86)\Inno Setup 6;$env:PATH"
        
        # Update version in installer script
        $issContent = Get-Content installer.iss -Raw
        $issContent = $issContent -replace '#define MyAppVersion "[^"]*"', "#define MyAppVersion `"${{ steps.get_version.outputs.VERSION }}`""
        $issContent | Out-File installer_temp.iss -Encoding UTF8
        
        # Compile installer
        iscc installer_temp.iss
        
        # Check if installer was created
        if (Test-Path "installer_output/HoldSense-Setup-v${{ steps.get_version.outputs.VERSION }}.exe") {
          Write-Host "Installer created successfully!"
        } else {
          Write-Error "Installer creation failed!"
          exit 1
        }

    # MSIX packaging temporarily disabled per request

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name || format('v{0}', steps.get_version.outputs.VERSION) }}
        name: HoldSense v${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
      files: |
       HoldSense-Portable-v${{ steps.get_version.outputs.VERSION }}.zip
       installer_output/HoldSense-Setup-v${{ steps.get_version.outputs.VERSION }}.exe
        body: |
          ## HoldSense v${{ steps.get_version.outputs.VERSION }}
          
          ### ðŸ“¦ Installation Options
          
       1. **EXE Installer (Recommended)**: `HoldSense-Setup-v${{ steps.get_version.outputs.VERSION }}.exe`
             - Full installer with shortcuts and uninstaller
             - Optionally starts on Windows startup
          
       2. **Portable ZIP**: `HoldSense-Portable-v${{ steps.get_version.outputs.VERSION }}.zip`
             - No installation required
             - Extract and run HoldSense.exe
          
          ### ðŸ“‹ Requirements
          - Windows 10 version 2004 (build 19041) or newer
          - Bluetooth-enabled PC with paired audio device
          - Webcam for automatic detection
          
          ### ðŸ”§ What's Included
          - HoldSense application with Python backend bundled
          - YOLOv8 phone detection model
          - All dependencies included (no Python installation needed)
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HoldSense-v${{ steps.get_version.outputs.VERSION }}
        path: |
          HoldSense-Portable-v${{ steps.get_version.outputs.VERSION }}.zip
          installer_output/*.exe
        retention-days: 30

